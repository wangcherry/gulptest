var execCmd = require('./execCmd');
var chalk = require('chalk');

module.exports = function (dir, branch, cb) {
	// add to git index, prepare to commit
	execCmd(['git', 'show-ref', '--verify', '--quiet', 'refs/heads/' + branch], {cwd: dir}, function(status1) {
		if(status1 === 0) {
			// local branch exists
			// remove untracked files from the working tree
			execCmd(['git', 'clean', '-f', '-d'], {cwd: dir}, function(){
				// reset all local modifications
				execCmd(['git', 'reset', '--hard'], {cwd: dir}, function(){
					execCmd(['git', 'show-ref', '--verify', '--quiet', 'refs/remotes/origin/' + branch], {cwd: dir}, function(status4){
						console.log(chalk.gray('show-ref status: ' + status4));
						if(status4 != 0) {
							// remote branch not exists
							execCmd(['git', 'push', '-u', 'origin', branch + ':' + branch], {cwd: dir});
						}
						execCmd(['git', 'fetch'], {cwd: dir});
						execCmd(['git', 'checkout', branch], {cwd: dir}, cb);
					});
				});
			});
		} else {
			// local branch not exists
			// create a branch
			execCmd(['git', 'checkout', '-B', branch], {cwd: dir}, function(status5){
				console.log(chalk.gray('checkout status: ' + status5));
				if(status5 != 0) {
					execCmd(['git', 'push', '-u', 'origin', branch + ':' + branch], {cwd: dir}, cb);
				}
			});
			
		}
	});
	
}


// git show-ref --verify --quiet refs/heads/"$__BRANCH"
//     if [ $? == 0 ]; then
//         ## local branch exists
//         ## remove untracked files from the working tree
// 	    git clean -f -d
// 	    ## reset all local modifications
// 	    git reset --hard
	    
// 	    git show-ref --verify --quiet refs/remotes/origin/"$__BRANCH"
// 	    if [ $? != 0 ]; then
// 	        ## remote branch not exists
//             ## push
// 	        git push -u origin "$__BRANCH":"$__BRANCH" || exit $?
// 	    fi
	    
// 	    git fetch && git checkout "$__BRANCH" && git rebase
//     else
//         ## local branch not exists
//         ## create a branch
//         git checkout -B "$__BRANCH" && git push -u origin "$__BRANCH":"$__BRANCH"
//     fi
//     
//     
//     
//     
//     
//     